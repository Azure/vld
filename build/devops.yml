name: $(BuildID)_$(BuildDefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)
resources:
- repo: self
  clean: true

parameters:
- name: architectures
  type: object
  default:
    - name: 'x64'
      cmakeArch: 'x64'
      vcvarsArg: 'amd64'
      platform: 'x64'
      pool: 'Azure-MessagingStore-WinBuildPoolVS2022_0'
      msbuildPath: 'C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\amd64\MSBuild.exe'
    - name: 'x86'
      cmakeArch: 'Win32'
      vcvarsArg: 'amd64_x86'
      platform: 'Win32'
      pool: 'Azure-MessagingStore-WinBuildPoolVS2022_0'
      msbuildPath: 'C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\amd64\MSBuild.exe'
    - name: 'arm64'
      cmakeArch: 'ARM64'
      vcvarsArg: 'arm64'
      platform: 'ARM64'
      pool: 'Azure-MessagingStore-WinBuildPoolARM'
      msbuildPath: 'C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\arm64\MSBuild.exe'
- name: configurations
  type: object
  default:
    - 'Debug'
    - 'RelWithDebInfo'

jobs:
- ${{ each arch in parameters.architectures }}:
  - ${{ each config in parameters.configurations }}:
    - job: Build_Windows_${{ arch.name }}_${{ config }}
      displayName: 'Build Windows ${{ arch.name }} ${{ config }}'
      pool:
        name: ${{ arch.pool }}
        demands:
        - Cmd
        - msbuild
        - visualstudio
        - Build
      steps:

      # Verify ARM64 agent architecture (provisioning script should have patched it)
      - ${{ if eq(arch.name, 'arm64') }}:
        - template: templates/verify-arm64-agent.yml

      # Setup VC++ environment for both CMake (compiler detection) and MSBuild
      - task: BatchScript@1
        displayName: 'Setup VC++ Environment (${{ arch.vcvarsArg }})'
        inputs:
          filename: '"C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat"'
          arguments: '${{ arch.vcvarsArg }}'
          modifyEnvironment: true

      - task: CMake@1
        displayName: 'CMake .. -DVLD_USE_MFC=OFF -A ${{ arch.cmakeArch }}'
        inputs:
          workingDirectory: 'build_${{ arch.name }}'
          cmakeArgs: '.. -DVLD_USE_MFC=OFF -A ${{ arch.cmakeArch }}'

      # Build solution using MSBuild directly (VSBuild/MSBuild tasks use x86 compiler on ARM64)
      - task: CmdLine@2
        displayName: 'Build solution ${{ config }}'
        inputs:
          script: '"${{ arch.msbuildPath }}" "build_${{ arch.name }}\VLD.sln" /t:restore /t:build /p:Platform=${{ arch.platform }} /p:Configuration=${{ config }} /m'

      - task: CmdLine@2
        displayName: 'Run ctest ${{ config }}'
        inputs:
          script: 'ctest -C "${{ config }}" --output-on-failure'
          workingDirectory: 'build_${{ arch.name }}'

      - task: PublishBuildArtifacts@1
        displayName: 'Publish ${{ arch.name }} ${{ config }} artifacts'
        condition: succeededOrFailed()
        inputs:
          pathToPublish: 'build_${{ arch.name }}/${{ config }}'
          artifactName: 'vld-${{ arch.name }}-${{ config }}'
