name: $(BuildID)_$(BuildDefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)
resources:
- repo: self
  clean: true

jobs:
- job: Build_ARM64
  displayName: 'Build ARM64 Simple Test'
  pool:
    name: 'Azure-MessagingStore-WinBuildPoolARM'
    demands:
    - Cmd
    - msbuild
    - visualstudio
  steps:

  - task: PowerShell@2
    displayName: 'Diagnostic: Show architecture'
    inputs:
      targetType: 'inline'
      script: |
        Write-Host "PROCESSOR_ARCHITECTURE: $env:PROCESSOR_ARCHITECTURE"
        Write-Host "PROCESSOR_ARCHITEW6432: $env:PROCESSOR_ARCHITEW6432"

  - task: PowerShell@2
    displayName: 'Add CMake to PATH'
    inputs:
      targetType: 'inline'
      script: |
        $cmakePath = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\IDE\CommonExtensions\Microsoft\CMake\CMake\bin"
        Write-Host "##vso[task.prependpath]$cmakePath"

  - task: CMake@1
    displayName: 'CMake -A ARM64'
    inputs:
      workingDirectory: 'build_arm64'
      cmakeArgs: '.. -A ARM64'

  # Use ARM64 MSBuild directly instead of VSBuild task
  - task: CmdLine@2
    displayName: 'Build with ARM64 MSBuild'
    inputs:
      script: |
        echo Using native ARM64 MSBuild...
        "%SystemRoot%\SysNative\cmd.exe" /c ""C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\arm64\msbuild.exe" build_arm64\SimpleTest.sln /p:Configuration=Debug /p:Platform=ARM64 /v:normal"
      workingDirectory: '$(Build.SourcesDirectory)'
