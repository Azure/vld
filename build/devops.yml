name: $(BuildID)_$(BuildDefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)
resources:
- repo: self
  clean: true

parameters:
- name: architectures
  type: object
  default:
    - name: 'x64'
      cmakeArch: 'x64'
      vcvarsArg: 'amd64'
      platform: 'x64'
      pool: 'Azure-MessagingStore-WinBuildPoolVS2022_0'
      isArm64: false
    - name: 'x86'
      cmakeArch: 'Win32'
      vcvarsArg: 'amd64_x86'
      platform: 'Win32'
      pool: 'Azure-MessagingStore-WinBuildPoolVS2022_0'
      isArm64: false
    - name: 'arm64'
      cmakeArch: 'ARM64'
      vcvarsArg: 'arm64_arm64'
      platform: 'ARM64'
      pool: 'Azure-MessagingStore-WinBuildPoolARM'
      isArm64: true
- name: configurations
  type: object
  default:
    - 'Debug'
    - 'RelWithDebInfo'

jobs:
- ${{ each arch in parameters.architectures }}:
  - ${{ each config in parameters.configurations }}:
    - job: Build_Windows_${{ arch.name }}_${{ config }}
      displayName: 'Build Windows ${{ arch.name }} ${{ config }}'
      pool:
        name: ${{ arch.pool }}
        demands:
        - Cmd
        - msbuild
        - visualstudio
        - Build
      steps:

      # Patch agent to ARM64 at runtime (workaround for x86 agent on ARM64 VMs)
      - ${{ if eq(arch.isArm64, true) }}:
        - template: templates/patch-agent-arm64.yml

      # Setup VC++ environment (handles ARM64 WoW64 escape internally)
      - template: templates/setup-vcvars.yml
        parameters:
          vcvarsArg: ${{ arch.vcvarsArg }}
          isArm64: ${{ arch.isArm64 }}
          includeDiagnostics: ${{ arch.isArm64 }}  # Only for ARM64

      # Ensure cmake is in PATH (Visual Studio bundled cmake)
      - ${{ if eq(arch.isArm64, true) }}:
        - task: PowerShell@2
          displayName: 'Add CMake to PATH'
          inputs:
            targetType: 'inline'
            script: |
              # Find cmake from Visual Studio installation
              $cmakePaths = @(
                  "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\IDE\CommonExtensions\Microsoft\CMake\CMake\bin",
                  "C:\Program Files\CMake\bin",
                  "C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\Common7\IDE\CommonExtensions\Microsoft\CMake\CMake\bin"
              )
              
              foreach ($path in $cmakePaths) {
                  if (Test-Path "$path\cmake.exe") {
                      Write-Host "Found cmake at: $path"
                      Write-Host "##vso[task.prependpath]$path"
                      exit 0
                  }
              }
              
              # Fallback: search Program Files
              $found = Get-ChildItem -Path "C:\Program Files" -Recurse -Filter "cmake.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($found) {
                  $cmakeDir = $found.DirectoryName
                  Write-Host "Found cmake at: $cmakeDir"
                  Write-Host "##vso[task.prependpath]$cmakeDir"
                  exit 0
              }
              
              Write-Host "##vso[task.logissue type=warning]Could not find cmake.exe"

      - task: CMake@1
        displayName: 'CMake .. -DVLD_USE_MFC=OFF -A ${{ arch.cmakeArch }}'
        inputs:
          workingDirectory: 'build_${{ arch.name }}'
          cmakeArgs: '.. -DVLD_USE_MFC=OFF -A ${{ arch.cmakeArch }}'

      # Build solution (handles ARM64 SysNative MSBuild internally)
      - template: templates/build-solution.yml
        parameters:
          solution: 'build_${{ arch.name }}\VLD.sln'
          platform: ${{ arch.platform }}
          configuration: ${{ config }}
          isArm64: ${{ arch.isArm64 }}

      - task: CmdLine@2
        displayName: 'Run ctest ${{ config }}'
        inputs:
          script: 'ctest -C "${{ config }}" --output-on-failure'
          workingDirectory: 'build_${{ arch.name }}'
