name: $(BuildID)_$(BuildDefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)
resources:
- repo: self
  clean: true

parameters:
- name: architectures
  type: object
  default:
    - name: 'x64'
      cmakeArch: 'x64'
      vcvarsArg: 'amd64'
      platform: 'x64'
      pool: 'Azure-MessagingStore-WinBuildPoolVS2022_0'
      msbuildPath: 'C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\amd64\MSBuild.exe'
    - name: 'x86'
      cmakeArch: 'Win32'
      vcvarsArg: 'amd64_x86'
      platform: 'Win32'
      pool: 'Azure-MessagingStore-WinBuildPoolVS2022_0'
      msbuildPath: 'C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\amd64\MSBuild.exe'
    - name: 'arm64'
      cmakeArch: 'ARM64'
      vcvarsArg: 'arm64'
      platform: 'ARM64'
      pool: 'BuildARM64Win8'
      msbuildPath: 'C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\arm64\MSBuild.exe'
- name: configurations
  type: object
  default:
    - 'Debug'
    - 'RelWithDebInfo'

jobs:
- ${{ each arch in parameters.architectures }}:
  - ${{ each config in parameters.configurations }}:
    - job: Build_Windows_${{ arch.name }}_${{ config }}
      displayName: 'Build Windows ${{ arch.name }} ${{ config }}'
      pool:
        name: ${{ arch.pool }}
        demands:
        - Cmd
        - msbuild
        - visualstudio
        - Build
      steps:
      - checkout: self
      - template: templates/build-arch.yml
        parameters:
          arch: ${{ arch.name }}
          cmakeArch: ${{ arch.cmakeArch }}
          vcvarsArg: ${{ arch.vcvarsArg }}
          platform: ${{ arch.platform }}
          msbuildPath: ${{ arch.msbuildPath }}
          configuration: ${{ config }}
          runTests: true
          artifactSuffix: '-${{ config }}'
