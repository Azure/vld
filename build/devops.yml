name: $(BuildID)_$(BuildDefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)
resources:
- repo: self
  clean: true

parameters:
- name: architectures
  type: object
  default:
    - name: 'x64'
      cmakeArch: 'x64'
      vcvarsArg: 'amd64'
      platform: 'x64'
      pool: 'Azure-MessagingStore-WinBuildPoolVS2022_0'
    - name: 'x86'
      cmakeArch: 'Win32'
      vcvarsArg: 'amd64_x86'
      platform: 'Win32'
      pool: 'Azure-MessagingStore-WinBuildPoolVS2022_0'
    - name: 'arm64'
      cmakeArch: 'ARM64'
      vcvarsArg: 'arm64'
      platform: 'ARM64'
      pool: 'Azure-MessagingStore-WinBuildPoolARM'
- name: configurations
  type: object
  default:
    - 'Debug'
    - 'RelWithDebInfo'

jobs:
- ${{ each arch in parameters.architectures }}:
  - ${{ each config in parameters.configurations }}:
    - job: Build_Windows_${{ arch.name }}_${{ config }}
      displayName: 'Build Windows ${{ arch.name }} ${{ config }}'
      pool:
        name: ${{ arch.pool }}
        demands:
        - Cmd
        - msbuild
        - visualstudio
        - Build
      steps:

      # Verify ARM64 agent architecture (provisioning script should have patched it)
      - ${{ if eq(arch.name, 'arm64') }}:
        - task: PowerShell@2
          displayName: 'Verify ARM64 Agent Architecture'
          inputs:
            targetType: 'inline'
            script: |
              Write-Host "============================================================"
              Write-Host "ARM64 AGENT VERIFICATION"
              Write-Host "============================================================"
              
              # Check process architecture
              $procArch = [System.Runtime.InteropServices.RuntimeInformation]::ProcessArchitecture
              Write-Host "Process Architecture: $procArch"
              Write-Host "PROCESSOR_ARCHITECTURE: $env:PROCESSOR_ARCHITECTURE"
              
              # Check Agent.Worker.exe PE header
              $agentDir = $env:AGENT_HOMEDIRECTORY
              $workerExe = Join-Path $agentDir "bin\Agent.Worker.exe"
              
              if (Test-Path $workerExe) {
                  $bytes = [System.IO.File]::ReadAllBytes($workerExe)
                  $peOffset = [BitConverter]::ToInt32($bytes, 0x3C)
                  $machine = [BitConverter]::ToUInt16($bytes, $peOffset + 4)
                  
                  $archName = switch ($machine) {
                      0x014C { "x86" }
                      0x8664 { "x64" }
                      0xAA64 { "ARM64" }
                      default { "Unknown (0x$($machine.ToString('X4')))" }
                  }
                  Write-Host "Agent.Worker.exe Architecture: $archName"
                  
                  if ($archName -ne "ARM64") {
                      Write-Host ""
                      Write-Host "##[error]ARM64 agent verification FAILED!"
                      Write-Host "##[error]Expected ARM64 agent but found $archName agent."
                      Write-Host ""
                      Write-Host "The 1ES provisioning script should patch the agent to ARM64."
                      Write-Host "Please investigate the provisioning script logs at:"
                      Write-Host "  https://winbuildpoolarm.blob.core.windows.net/insights-logs-provisioningscriptlogs"
                      Write-Host ""
                      Write-Host "Look for 'ARM64 Agent Provisioning Script' entries."
                      Write-Host "See build/docs/ARM64-AGENT-PATCHING.md for troubleshooting."
                      exit 1
                  }
                  
                  Write-Host ""
                  Write-Host "ARM64 agent verification PASSED!"
              } else {
                  Write-Host "##[warning]Could not find Agent.Worker.exe at $workerExe"
              }
              
              Write-Host "============================================================"

      # Setup VC++ environment
      - template: templates/setup-vcvars.yml
        parameters:
          vcvarsArg: ${{ arch.vcvarsArg }}

      - task: CMake@1
        displayName: 'CMake .. -DVLD_USE_MFC=OFF -A ${{ arch.cmakeArch }}'
        inputs:
          workingDirectory: 'build_${{ arch.name }}'
          cmakeArgs: '.. -DVLD_USE_MFC=OFF -A ${{ arch.cmakeArch }}'

      # Build solution
      - template: templates/build-solution.yml
        parameters:
          solution: 'build_${{ arch.name }}\VLD.sln'
          platform: ${{ arch.platform }}
          configuration: ${{ config }}

      - task: CmdLine@2
        displayName: 'Run ctest ${{ config }}'
        inputs:
          script: 'ctest -C "${{ config }}" --output-on-failure'
          workingDirectory: 'build_${{ arch.name }}'
