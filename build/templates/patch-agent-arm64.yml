# templates/patch-agent-arm64.yml
# Patches the Azure Pipelines Agent to native ARM64 at runtime.
# This is a workaround for 1ES Hosted Pools that provision x86/x64 agents on ARM64 VMs.
# Run this at the start of ARM64 jobs before any builds.

steps:
- powershell: |
    Write-Host "========================================="
    Write-Host "ARM64 Agent Runtime Patch"
    Write-Host "========================================="
    
    # Find agent installation
    $agentPath = $null
    $vssAgentRoot = "C:\vss-agent"
    if (Test-Path $vssAgentRoot) {
        $versionFolders = Get-ChildItem -Path $vssAgentRoot -Directory | Sort-Object Name -Descending
        foreach ($folder in $versionFolders) {
            if (Test-Path "$($folder.FullName)\bin\Agent.Listener.exe") {
                $agentPath = $folder.FullName
                break
            }
        }
    }
    
    if (-not $agentPath) {
        Write-Host "No agent found at C:\vss-agent - skipping patch"
        exit 0
    }
    
    Write-Host "Agent path: $agentPath"
    
    # Check current architecture by reading PE header
    $exePath = "$agentPath\bin\Agent.Listener.exe"
    $stream = [System.IO.File]::OpenRead($exePath)
    $bytes = New-Object byte[] 512
    $stream.Read($bytes, 0, 512) | Out-Null
    $stream.Close()
    
    $peOffset = [BitConverter]::ToInt32($bytes, 0x3C)
    $machine = [BitConverter]::ToUInt16($bytes, $peOffset + 4)
    
    $arch = switch ($machine) {
        0x014C { "x86" }
        0x8664 { "x64" }
        0xAA64 { "ARM64" }
        default { "Unknown" }
    }
    
    Write-Host "Current agent architecture: $arch"
    
    if ($arch -eq "ARM64") {
        Write-Host "Agent is already ARM64 - no patch needed!"
        exit 0
    }
    
    # Get version from folder name
    $version = Split-Path -Leaf $agentPath
    if ($version -notmatch '^\d+\.\d+\.\d+$') {
        Write-Host "##[warning]Could not determine agent version from folder name: $version"
        exit 0
    }
    
    Write-Host "Agent version: $version"
    Write-Host ""
    Write-Host "Downloading ARM64 agent..."
    
    $agentZip = "vsts-agent-win-arm64-$version.zip"
    $downloadPath = "$env:TEMP\agent-arm64-patch"
    $downloadUrl = "https://download.agent.dev.azure.com/agent/$version/$agentZip"
    
    if (-not (Test-Path $downloadPath)) {
        New-Item -ItemType Directory -Path $downloadPath -Force | Out-Null
    }
    
    Invoke-WebRequest -Uri $downloadUrl -OutFile "$downloadPath\$agentZip" -UseBasicParsing
    
    if (-not (Test-Path "$downloadPath\$agentZip")) {
        Write-Host "##[error]Failed to download ARM64 agent"
        exit 1
    }
    
    Write-Host "Download complete. Extracting with overwrite..."
    
    # Backup config files
    $configBackup = @{}
    $configFiles = @(".agent", ".credentials", ".credentials_rsaparams", ".service", ".proxy", ".proxybypass", ".proxyauth")
    foreach ($file in $configFiles) {
        $filePath = "$agentPath\$file"
        if (Test-Path $filePath) {
            $configBackup[$file] = Get-Content $filePath -Raw -ErrorAction SilentlyContinue
        }
    }
    
    # Extract with overwrite
    Add-Type -AssemblyName System.IO.Compression.FileSystem
    $zip = [System.IO.Compression.ZipFile]::OpenRead("$downloadPath\$agentZip")
    foreach ($entry in $zip.Entries) {
        $destPath = Join-Path $agentPath $entry.FullName
        $destDir = Split-Path $destPath -Parent
        if (-not (Test-Path $destDir)) {
            New-Item -ItemType Directory -Path $destDir -Force | Out-Null
        }
        if (-not $entry.FullName.EndsWith('/')) {
            [System.IO.Compression.ZipFileExtensions]::ExtractToFile($entry, $destPath, $true)
        }
    }
    $zip.Dispose()
    
    # Restore config files
    foreach ($file in $configBackup.Keys) {
        if ($configBackup[$file]) {
            Set-Content -Path "$agentPath\$file" -Value $configBackup[$file] -NoNewline -ErrorAction SilentlyContinue
        }
    }
    
    # Verify
    $stream = [System.IO.File]::OpenRead($exePath)
    $bytes = New-Object byte[] 512
    $stream.Read($bytes, 0, 512) | Out-Null
    $stream.Close()
    $peOffset = [BitConverter]::ToInt32($bytes, 0x3C)
    $machine = [BitConverter]::ToUInt16($bytes, $peOffset + 4)
    $newArch = switch ($machine) {
        0x014C { "x86" }
        0x8664 { "x64" }
        0xAA64 { "ARM64" }
        default { "Unknown" }
    }
    
    Write-Host ""
    Write-Host "========================================="
    Write-Host "Patch complete! New architecture: $newArch"
    Write-Host "========================================="
    
    if ($newArch -ne "ARM64") {
        Write-Host "##[error]Patch verification failed"
        exit 1
    }
    
    # Cleanup
    Remove-Item "$downloadPath\$agentZip" -Force -ErrorAction SilentlyContinue
    
  displayName: 'Patch agent to ARM64'
  condition: succeeded()
