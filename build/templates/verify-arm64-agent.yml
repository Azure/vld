# Template: Verify ARM64 Agent Architecture
# Checks and reports the agent architecture (may be running under x86 emulation).

steps:
  - task: PowerShell@2
    displayName: 'Verify ARM64 Agent Architecture'
    inputs:
      targetType: 'inline'
      script: |
        Write-Host "============================================================"
        Write-Host "ARM64 AGENT VERIFICATION"
        Write-Host "============================================================"
        
        # Check process architecture
        $procArch = [System.Runtime.InteropServices.RuntimeInformation]::ProcessArchitecture
        $pid = $PID
        Write-Host "Process Architecture: $procArch"
        Write-Host "Process ID (PID): $pid"
        Write-Host "PROCESSOR_ARCHITECTURE: $env:PROCESSOR_ARCHITECTURE"
        
        # Check Agent.Worker.exe PE header
        $agentDir = $env:AGENT_HOMEDIRECTORY
        $workerExe = Join-Path $agentDir "bin\Agent.Worker.exe"
        
        if (Test-Path $workerExe) {
            $bytes = [System.IO.File]::ReadAllBytes($workerExe)
            $peOffset = [BitConverter]::ToInt32($bytes, 0x3C)
            $machine = [BitConverter]::ToUInt16($bytes, $peOffset + 4)
            
            $archName = switch ($machine) {
                0x014C { "x86" }
                0x8664 { "x64" }
                0xAA64 { "ARM64" }
                default { "Unknown (0x$($machine.ToString('X4')))" }
            }
            Write-Host "Agent.Worker.exe Architecture: $archName"
            Write-Host "Agent.Worker.exe Path: $workerExe"
            
            if ($archName -ne "ARM64") {
                Write-Host ""
                Write-Host "##[warning]============================================================"
                Write-Host "##[warning]ARM64 AGENT ARCHITECTURE MISMATCH"
                Write-Host "##[warning]============================================================"
                Write-Host "##[warning]"
                Write-Host "##[warning]Detection results:"
                Write-Host "##[warning]  Process Architecture:      $procArch"
                Write-Host "##[warning]  Process ID (PID):          $pid"
                Write-Host "##[warning]  PROCESSOR_ARCHITECTURE:    $env:PROCESSOR_ARCHITECTURE"
                Write-Host "##[warning]  Agent.Worker.exe:          $archName"
                Write-Host "##[warning]"
                Write-Host "##[warning]Expected ARM64 agent but found $archName agent."
                Write-Host "##[warning]"
                Write-Host "##[warning]Continuing build despite architecture mismatch..."
                Write-Host "##[warning]============================================================"
            } else {
                Write-Host ""
                Write-Host "ARM64 agent verification PASSED!"
            }
        } else {
            Write-Host "##[warning]Could not find Agent.Worker.exe at $workerExe"
        }
        
        Write-Host "============================================================"
