# Template: Verify ARM64 Agent Architecture
# Ensures the 1ES provisioning script has patched the agent to ARM64.
# See build/docs/ARM64-AGENT-PATCHING.md for details.

steps:
  - task: PowerShell@2
    displayName: 'Verify ARM64 Agent Architecture'
    inputs:
      targetType: 'inline'
      script: |
        Write-Host "============================================================"
        Write-Host "PROVISIONING LOG OUTPUT"
        Write-Host "============================================================"
        
        # Output C:\ProvisioningLog.txt if it exists (before any other checks)
        $provisioningLog = "C:\ProvisioningLog.txt"
        if (Test-Path $provisioningLog) {
            Write-Host "Contents of $provisioningLog :"
            Write-Host "------------------------------------------------------------"
            Get-Content $provisioningLog
            Write-Host "------------------------------------------------------------"
        } else {
            Write-Host "##[warning]$provisioningLog does not exist."
        }
        
        Write-Host ""
        Write-Host "============================================================"
        Write-Host "ARM64 AGENT VERIFICATION"
        Write-Host "============================================================"
        
        # Check process architecture
        $procArch = [System.Runtime.InteropServices.RuntimeInformation]::ProcessArchitecture
        Write-Host "Process Architecture: $procArch"
        Write-Host "PROCESSOR_ARCHITECTURE: $env:PROCESSOR_ARCHITECTURE"
        
        # Detect computer (OS) architecture
        $osArch = (Get-CimInstance Win32_OperatingSystem).OSArchitecture
        Write-Host "OS Architecture: $osArch"
        
        # Check Agent.Worker.exe PE header
        $agentDir = $env:AGENT_HOMEDIRECTORY
        $workerExe = Join-Path $agentDir "bin\Agent.Worker.exe"
        
        if (Test-Path $workerExe) {
            $bytes = [System.IO.File]::ReadAllBytes($workerExe)
            $peOffset = [BitConverter]::ToInt32($bytes, 0x3C)
            $machine = [BitConverter]::ToUInt16($bytes, $peOffset + 4)
            
            $archName = switch ($machine) {
                0x014C { "x86" }
                0x8664 { "x64" }
                0xAA64 { "ARM64" }
                default { "Unknown (0x$($machine.ToString('X4')))" }
            }
            Write-Host "Agent.Worker.exe Architecture: $archName"
            
            if ($archName -ne "ARM64") {
                Write-Host ""
                Write-Host "##[warning]ARM64 agent verification FAILED!"
                Write-Host "##[warning]Expected ARM64 agent but found $archName agent."
                Write-Host ""
                Write-Host "The 1ES provisioning script should patch the agent to ARM64."
                Write-Host "Please investigate the provisioning script logs at:"
                Write-Host "  https://winbuildpoolarm.blob.core.windows.net/insights-logs-provisioningscriptlogs"
                Write-Host ""
                Write-Host "Look for 'ARM64 Agent Provisioning Script' entries."
                Write-Host "See build/docs/ARM64-AGENT-PATCHING.md for troubleshooting."
                
                # If OS is ARM64 but agent is x86, continue running (don't fail)
                if ($osArch -like "*ARM64*" -and $archName -eq "x86") {
                    Write-Host ""
                    Write-Host "##[warning]Computer is ARM64 but agent is x86. Continuing anyway..."
                    Write-Host "##[warning]Build will proceed using x86 emulation on ARM64."
                } else {
                    exit 1
                }
            } else {
                Write-Host ""
                Write-Host "ARM64 agent verification PASSED!"
            }
        } else {
            Write-Host "##[warning]Could not find Agent.Worker.exe at $workerExe"
        }
        
        Write-Host "============================================================"
