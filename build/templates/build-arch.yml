# Template for building VLD for a single architecture
# Used by both devops.yml (CI) and official.yml (release)

parameters:
- name: arch
  type: string
  values: ['x64', 'x86', 'arm64']
- name: configuration
  type: string
  default: 'RelWithDebInfo'
- name: runTests
  type: boolean
  default: false
- name: artifactSuffix
  type: string
  default: ''

steps:
# Verify ARM64 agent architecture (provisioning script should have patched it)
- ${{ if eq(parameters.arch, 'arm64') }}:
  - template: verify-arm64-agent.yml

# Discover Visual Studio and setup build environment
- task: PowerShell@2
  displayName: 'Setup Build Environment (${{ parameters.arch }})'
  inputs:
    targetType: 'inline'
    script: |
      # Map arch to platform and msbuild host folder
      $arch = "${{ parameters.arch }}"
      switch ($arch) {
        'x64'   { $vcvarsArg = 'amd64';     $cmakeArch = 'x64';   $platform = 'x64';   $msbuildHost = 'amd64' }
        'x86'   { $vcvarsArg = 'amd64_x86'; $cmakeArch = 'Win32'; $platform = 'Win32'; $msbuildHost = 'amd64' }
        'arm64' { $vcvarsArg = 'arm64';     $cmakeArch = 'ARM64'; $platform = 'ARM64'; $msbuildHost = 'arm64' }
      }
      Write-Host "##vso[task.setvariable variable=cmakeArch]$cmakeArch"
      Write-Host "##vso[task.setvariable variable=platform]$platform"
      
      $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
      if (-not (Test-Path $vswhere)) {
        Write-Host "##[error]vswhere.exe not found at $vswhere"
        exit 1
      }
      
      $vsPath = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -property installationPath
      if (-not $vsPath) {
        Write-Host "##[error]Could not find Visual Studio installation"
        exit 1
      }
      Write-Host "Found Visual Studio at: $vsPath"
      
      # Find MSBuild for the correct host architecture
      $msbuildPath = Join-Path $vsPath "MSBuild\Current\Bin\$msbuildHost\MSBuild.exe"
      if (-not (Test-Path $msbuildPath)) {
        $msbuildPath = Join-Path $vsPath "MSBuild\Current\Bin\MSBuild.exe"
      }
      if (-not (Test-Path $msbuildPath)) {
        Write-Host "##[error]MSBuild.exe not found"
        exit 1
      }
      Write-Host "Using MSBuild: $msbuildPath"
      Write-Host "##vso[task.setvariable variable=msbuildPath]$msbuildPath"
      
      # Run vcvarsall to add cmake and other tools to PATH
      $vcvarsall = Join-Path $vsPath "VC\Auxiliary\Build\vcvarsall.bat"
      if (-not (Test-Path $vcvarsall)) {
        Write-Host "##[error]vcvarsall.bat not found at $vcvarsall"
        exit 1
      }
      
      Write-Host "Calling vcvarsall to setup PATH (needed for cmake): $vcvarsArg"
      cmd /c "`"$vcvarsall`" $vcvarsArg && set" | ForEach-Object {
        if ($_ -match '^([^=]+)=(.*)$') {
          Write-Host "##vso[task.setvariable variable=$($matches[1])]$($matches[2])"
        }
      }

- task: CmdLine@2
  displayName: 'CMake configure'
  inputs:
    script: |
      mkdir build_${{ parameters.arch }} 2>nul
      cd build_${{ parameters.arch }}
      cmake .. -DVLD_USE_MFC=OFF -A $(cmakeArch)

- task: CmdLine@2
  displayName: 'Build ${{ parameters.configuration }}'
  inputs:
    script: '"$(msbuildPath)" "build_${{ parameters.arch }}\VLD.sln" /t:restore /t:build /p:Platform=$(platform) /p:Configuration=${{ parameters.configuration }} /m'

# Optional: Run tests
- ${{ if parameters.runTests }}:
  - task: CmdLine@2
    displayName: 'Run ctest ${{ parameters.configuration }}'
    inputs:
      script: 'ctest -C "${{ parameters.configuration }}" --output-on-failure'
      workingDirectory: 'build_${{ parameters.arch }}'

- task: PublishPipelineArtifact@1
  displayName: 'Publish ${{ parameters.arch }}${{ parameters.artifactSuffix }} build'
  inputs:
    targetPath: 'build_${{ parameters.arch }}'
    artifact: 'build_${{ parameters.arch }}${{ parameters.artifactSuffix }}'
